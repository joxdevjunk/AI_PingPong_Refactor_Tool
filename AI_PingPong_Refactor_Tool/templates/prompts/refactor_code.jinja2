# ğŸ”„ Refactoring Code - {{ project_name }}

{% include 'sections/context.jinja2' %}

## ğŸ“š Nomenclature du Code Ã  Refactorer

{% if selected_tasks %}
{# === SECTION 1: Vue globale des variables d'instance === #}
{% set all_classes = selected_tasks | map(attribute='class_name') | unique | list %}
{% for class_name in all_classes %}
{% set class_tasks = selected_tasks | selectattr('class_name', 'equalto', class_name) | list %}
{% set first_task = class_tasks[0] %}

**Classe : `{{ class_name }}`**

### Variables d'instance disponibles

{% if first_task.get('instance_variables_by_method') %}
{% for method, vars in first_task['instance_variables_by_method'].items() %}
- `{{ method }}()` dÃ©finit : `{{ vars | join('`, `') }}`
{% endfor %}
{% else %}
- Aucune variable d'instance dÃ©tectÃ©e
{% endif %}

### MÃ©thodes Ã  refactorer

{% for task in class_tasks %}
**`{{ task['method_name'] }}()`** :
{% set local_vars = task.get('local_vars', {}) %}
- ParamÃ¨tres : `{{ local_vars.get('parameters', []) | join('`, `') if local_vars.get('parameters') else 'aucun' }}`
- Variables locales : `{{ local_vars.get('assigned', []) | join('`, `') if local_vars.get('assigned') else 'aucune' }}`
- Variables de boucle : `{{ local_vars.get('for_vars', []) | join('`, `') if local_vars.get('for_vars') else 'aucune' }}`
- Variables with : `{{ local_vars.get('with_vars', []) | join('`, `') if local_vars.get('with_vars') else 'aucune' }}`

{% endfor %}

---

{% endfor %}

ğŸš¨ **RÃˆGLES ABSOLUES** :
- âŒ N'invente JAMAIS de nouveaux noms de variables
- âœ… Utilise UNIQUEMENT les noms listÃ©s ci-dessus
- âœ… Respecte EXACTEMENT la nomenclature du projet

{% endif %}

## ğŸ“‹ Objectif du Refactoring

{{ refactor_goal if refactor_goal else "âš ï¸ Objectif du refactoring Ã  prÃ©ciser (amÃ©lioration performance, lisibilitÃ©, maintenabilitÃ©, etc.)" }}

## ğŸ“ Code Ã  Refactorer

{% if num_tasks == 0 %}
âš ï¸ **Aucune task sÃ©lectionnÃ©e** - SÃ©lectionnez le code Ã  refactorer.
{% else %}
{% for task in selected_tasks %}
{% include 'sections/code_snippet.jinja2' %}
{% endfor %}
{% endif %}

{% if constraints %}
## âš ï¸ Contraintes

{{ constraints }}
{% endif %}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš¨ FORMAT JSON OBLIGATOIRE - RÃ‰PONSE EN FRANÃ‡AIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš ï¸âš ï¸âš ï¸ EXIGENCE CRITIQUE DE FORMAT âš ï¸âš ï¸âš ï¸

TU ES UN EXPERT SENIOR EN REFACTORING PYTHON.

Ta rÃ©ponse DOIT Ãªtre UNIQUEMENT le JSON ci-dessous, **ENTIÃˆREMENT EN FRANÃ‡AIS**.
AUCUNE explication, AUCUN bloc markdown, AUCUN texte avant/aprÃ¨s.
Commence par `{` sur la premiÃ¨re ligne, termine par `}` sur la derniÃ¨re.

## ğŸ¯ Ta Mission

Analyse les mÃ©thodes sÃ©lectionnÃ©es et propose un plan de refactoring structurÃ© et parsable.

**GÃ‰NÃˆRE EXACTEMENT cette structure JSON :**

{
  "executive_summary": {
    "severity": "HIGH|MEDIUM|LOW",
    "primary_issue": "ProblÃ¨me architectural principal identifiÃ© (1 phrase)",
    "refactoring_urgency": "Ã‰levÃ©e|Moyenne|Faible - Justification brÃ¨ve",
    "affected_methods_count": {{ num_tasks }},
    "estimated_total_effort": "X heures|jours"
  },
  
  "critical_issues_prioritized": [
    {
      "priority": "P0|P1|P2",
      "category": "architecture|complexitÃ©|duplication|documentation|performance",
      "issue": "Titre clair du problÃ¨me (max 60 caractÃ¨res)",
      "affected_methods": [{% for task in selected_tasks %}"{{ task['method_name'] }}"{% if not loop.last %}, {% endif %}{% endfor %}],
      "description": "Explication dÃ©taillÃ©e du problÃ¨me (2-3 phrases)",
      "impact": "Pourquoi Ã§a nuit Ã  la maintenabilitÃ© (en franÃ§ais)",
      "solution": "Ã‰tapes concrÃ¨tes de refactoring",
      "effort": "X heures",
      "benefits": [
        "BÃ©nÃ©fice 1",
        "BÃ©nÃ©fice 2"
      ]
    }
  ],
  
  "targeted_refactoring_plan": {
    "philosophy": "StratÃ©gie globale de refactoring (2-3 phrases)",
    
    "phase_1_extraction_methodes": {
      "duration": "X heures",
      "priority": "P0",
      "goal": "Objectif de cette phase",
      "tasks": [
        "TÃ¢che spÃ©cifique 1",
        "TÃ¢che spÃ©cifique 2",
        "TÃ¢che spÃ©cifique 3"
      ],
      "result": {
        "methods_created": ["methode_1", "methode_2"],
        "lines_reduced": "~XXX lignes",
        "complexity_improvement": "De CRITIQUE Ã  MOYENNE"
      }
    },
    
    "phase_2_organisation_code": {
      "duration": "X heures",
      "priority": "P1",
      "goal": "Objectif de cette phase",
      "tasks": [
        "TÃ¢che spÃ©cifique 1",
        "TÃ¢che spÃ©cifique 2"
      ],
      "result": {
        "files_created": ["nouveau_fichier.py"],
        "responsibility_separation": "Description"
      }
    },
    
    "phase_3_tests_documentation": {
      "duration": "X heures",
      "priority": "P2",
      "goal": "Objectif de cette phase",
      "tasks": [
        "TÃ¢che spÃ©cifique 1",
        "TÃ¢che spÃ©cifique 2"
      ],
      "result": {
        "test_coverage": "XX%",
        "documentation": "Complete"
      }
    }
  },
  
  "method_by_method_refactoring": {
{% for task in selected_tasks %}
    "{{ task['method_name'] }}": {
      "current_state": {
        "lines": "A ESTIMER",
        "complexity": "CRITIQUE|Ã‰LEVÃ‰E|MOYENNE",
        "main_issues": ["ProblÃ¨me 1 Ã  identifier", "ProblÃ¨me 2 Ã  identifier"]
      },
      "refactoring_approach": "Comment refactorer cette mÃ©thode spÃ©cifique",
      "split_into": [
        {
          "method": "_{{ task['method_name'] }}_partie_1",
          "responsibility": "PremiÃ¨re responsabilitÃ© extraite",
          "lines_est": 15,
          "complexity": "FAIBLE"
        },
        {
          "method": "_{{ task['method_name'] }}_partie_2",
          "responsibility": "DeuxiÃ¨me responsabilitÃ© extraite",
          "lines_est": 20,
          "complexity": "MOYENNE"
        }
      ],
      "new_orchestrator": {
        "method": "{{ task['method_name'] }}",
        "lines_est": 10,
        "role": "Orchestrateur lÃ©ger qui coordonne les mÃ©thodes extraites"
      }
    }{% if not loop.last %},{% endif %}
{% endfor %}
  },
  
  "immediate_quick_wins": [
    {
      "action": "Action rapide Ã  faire (max 60 caractÃ¨res)",
      "effort": "X heures",
      "impact": "HIGH|MEDIUM - Description du bÃ©nÃ©fice",
      "priority": "P0",
      "steps": [
        "Ã‰tape 1",
        "Ã‰tape 2",
        "Ã‰tape 3"
      ]
    }
  ],
  
  "risk_assessment": {
    "regression_risque": {
      "level": "Ã‰LEVÃ‰|MOYEN|FAIBLE",
      "description": "Ce qui pourrait casser",
      "mitigation": "Comment le prÃ©venir",
      "rollback_plan": "Comment annuler si Ã§a Ã©choue"
    },
    "integration_risque": {
      "level": "Ã‰LEVÃ‰|MOYEN|FAIBLE",
      "description": "Impact sur le reste du code",
      "mitigation": "Tests Ã  faire"
    }
  },
  
  "success_metrics": {
    "before_refactoring": {
      "methods": {{ num_tasks }},
      "total_lines": "A CALCULER",
      "complexity_critical_count": "A ANALYSER"
    },
    "after_refactoring": {
      "methods": "X",
      "total_lines": "X",
      "complexity_critical_count": "0",
      "maintainability_improvement": "+XX%"
    }
  },
  
  "total_effort_estimate": {
    "phase_1": "X heures",
    "phase_2": "X heures",
    "phase_3": "X heures",
    "total": "X heures",
    "with_buffer_20_percent": "X heures",
    "note": "Pourquoi cette estimation"
  },
  
  "recommendation": {
    "priority": "Ã‰LEVÃ‰E|MOYENNE|FAIBLE - Quand commencer",
    "approach": "RÃ©sumÃ© de la stratÃ©gie recommandÃ©e",
    "rationale": "Pourquoi cette approche",
    "quick_start": [
      "Jour 1: PremiÃ¨res Ã©tapes",
      "Jour 2: Ã‰tapes suivantes",
      "Jour 3: Finalisation"
    ]
  }
}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ CHECKLIST DE VALIDATION JSON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Avant de soumettre, vÃ©rifie:
âœ… La rÃ©ponse commence par `{` (pas de texte avant)
âœ… La rÃ©ponse termine par `}` (pas de texte aprÃ¨s)
âœ… Toutes les chaÃ®nes utilisent des guillemets doubles "..." pas simples '...'
âœ… Pas de virgules traÃ®nantes dans les tableaux/objets
âœ… TOUT LE CONTENU TEXTUEL EST EN FRANÃ‡AIS
âœ… executive_summary existe et est rempli
âœ… critical_issues_prioritized a 3-7 items minimum
âœ… targeted_refactoring_plan a des phases avec tÃ¢ches concrÃ¨tes
âœ… immediate_quick_wins a 3-5 actions
âœ… method_by_method_refactoring couvre toutes les mÃ©thodes sÃ©lectionnÃ©es

GÃ‰NÃˆRE UNIQUEMENT DU JSON PUR EN FRANÃ‡AIS. PAS DE MARKDOWN. PAS D'EXPLICATIONS.
Premier caractÃ¨re: {
Dernier caractÃ¨re: }
